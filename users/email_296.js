var users_296_308 = [

	{
		"uname_in_bbs":"坚强与勇敢",//296
		"email":"348761434@qq.com",
		"email_2":"",
		"qq":348761434,
		"show_mail_time":"2013-07-05  02:06:38",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"被钓起的鱼",//298
		"email":"1755437674@qq.com",
		"email_2":"",
		"qq":1755437674,
		"show_mail_time":"2013-07-12  14:35:44",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"shaolin317",//298
		"email":"shaolin317@126.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-07-13  10:01:49",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"thclyy",//298
		"email":"liyouyuan2005@126.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-07-18  15:09:46",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"天崖论落人2013",//298
		"email":"757474502@qq.com",
		"email_2":"",
		"qq":757474502,
		"show_mail_time":"2013-07-20  19:47:52",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"杰杰爱伟伟",//302
		"email":"574483054@qq.com",
		"email_2":"",
		"qq":574483054,
		"show_mail_time":"2013-08-10  00:26:00",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"Run_plan",//302
		"email":"1832259003@qq.com",
		"email_2":"",
		"qq":1832259003,
		"show_mail_time":"2013-08-15  00:07:40",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"thatsthat",//302
		"email":"t4tnotrt@163.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-08-16  09:03:23",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"thclyy",//303
		"email":"420221349@qq.com",
		"email_2":"liyouyuan2005@163.com",
		"qq":420221349,
		"show_mail_time":"2013-08-29  13:42:04",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"农民工ym",
		"email":"244456979@qq.com",
		"email_2":"",
		"qq":244456979,
		"show_mail_time":"2013-08-31  23:42:57",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"箫羿",
		"email":"rewee@126.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2007-06-01  09:57:17",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"漂泊无迹",//296
		"email":"nh2212694@163.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-07-05  22:00:31",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"愚民教育部",
		"email":"lhs0526@163.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-07-06  12:11:27",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"小屁黑鬼",
		"email":"xie_keyu@sohu.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-07-06  12:56:41",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"天池农民",
		"email":"289405734@qq.com",
		"email_2":"",
		"qq":289405734,
		"show_mail_time":"2013-07-06  21:36:21",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"垂髫老翁",
		"email":"496837194@qq.com",
		"email_2":"",
		"qq":496837194,
		"show_mail_time":"2013-07-06  21:46:33",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"乐在灬火线",
		"email":"178298727@qq.com",
		"email_2":"",
		"qq":178298727,
		"show_mail_time":"2013-07-06  22:59:06",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"leelinleelin",
		"email":"1413486966@qq.com",
		"email_2":"",
		"qq":1413486966,
		"show_mail_time":"2013-07-07  01:18:47",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"月季之恋",
		"email":"113025125@qq.com",
		"email_2":"",
		"qq":113025125,
		"show_mail_time":"2013-07-07  10:12:21",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"summerbird56",
		"email":"13520805162@163.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-07-07  21:18:17",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"创业不易2012",
		"email":"328046020@qq.com",
		"email_2":"",
		"qq":328046020,
		"show_mail_time":"2013-07-08  10:14:20",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"ssk336688",
		"email":"541760372@qq.com",
		"email_2":"",
		"qq":541760372,
		"show_mail_time":"2013-07-08  21:25:23",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"俗人黄",
		"email":"yygyje987601@163.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-07-08  22:58:33",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"沧海劫涩",
		"email":"308055868@qq.com",
		"email_2":"",
		"qq":308055868,
		"show_mail_time":"2013-07-09  08:15:16",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"大屋见小屋",
		"email":"114525134@qq.com",
		"email_2":"",
		"qq":114525134,
		"show_mail_time":"2013-07-10  00:19:49",
		"label":[],
		"intro":"",
		"tags":["思维导图"]
	},
	{
		"uname_in_bbs":"等待一种风景",//308
		"email":"328673053@QQ.COM",
		"email_2":"",
		"qq":328673053,
		"show_mail_time":"2013-11-06  16:18:46",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"我心依善",//308
		"email":"415326542@qq.com",
		"email_2":"",
		"qq":415326542,
		"show_mail_time":"2013-11-06  17:41:46",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"匪身闯天堂",//308
		"email":"271334537@qq.com",
		"email_2":"",
		"qq":271334537,
		"show_mail_time":"2013-11-15  15:50:57",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"miss张不思念",//308
		"email":"11461146@qq.com",
		"email_2":"",
		"qq":11461146,
		"show_mail_time":"2013-11-13  22:20:27",
		"label":[],
		"intro":"",
		"tags":["中国梦的解析"]
	},
	{
		"uname_in_bbs":"jianrenwuzhe",//308
		"email":"2501976481@qq.com",
		"email_2":"",
		"qq":2501976481,
		"show_mail_time":"2013-11-14  00:18:55",
		"label":[],
		"intro":"",
		"tags":["中国梦的解析"]
	},
	{
		"uname_in_bbs":"小小衙役NEW",//305
		"email":"liuxi.girl@gmail.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-09-20  12:54:59",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"沧海劫涩",//305
		"email":"308055868@qq.com",
		"email_2":"",
		"qq":308055868,
		"show_mail_time":"2013-09-20  23:37:00",
		"label":[],
		"intro":"",
		"tags":["王功权"]
	},
	{
		"uname_in_bbs":"jianrenwuzhe",
		"email":"2501976481@qq.com",
		"email_2":"",
		"qq":2501976481,
		"show_mail_time":"2013-09-21  05:38:24",
		"label":[],
		"intro":"",
		"tags":["王功权"]
	},
	{
		"uname_in_bbs":"冰水游侠",
		"email":"sxf@gshug.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-09-21  11:19:09",
		"label":[],
		"intro":"",
		"tags":["王功权"]
	},
	{
		"uname_in_bbs":"jianrenwuzhe",
		"email":"2501976481@qq.com",
		"email_2":"",
		"qq":2501976481,
		"show_mail_time":"2013-10-29  23:02:39",
		"label":[],
		"intro":"",
		"tags":["王功权"]
	},
	{
		"uname_in_bbs":"飘落8T",
		"email":"luchunhua6@qq.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-09-21  13:00:29",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"飘落8T",
		"email":"luchunhua6@qq.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-09-21  13:02:05",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"纪峰_帝國崛起",
		"email":"583475137@qq.com",
		"email_2":"",
		"qq":583475137,
		"show_mail_time":"2013-09-22  02:31:16",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"muzishanyu",
		"email":"308055868@qq.com",
		"email_2":"",
		"qq":308055868,
		"show_mail_time":"2013-09-24  11:33:43",
		"label":[],
		"intro":"",
		"tags":["王功权"]
	},
	{
		"uname_in_bbs":"ever73",
		"email":"ever73@163.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-09-26  12:19:31",
		"label":[],
		"intro":"",
		"tags":["王功权"]
	},
	{
		"uname_in_bbs":"liyufeng1987",
		"email":"1743652738@qq.com",
		"email_2":"",
		"qq":1743652738,
		"show_mail_time":"2013-09-27  23:47:44",
		"label":[],
		"intro":"",
		"tags":["王功权"]
	},
	{
		"uname_in_bbs":"司马无妄",
		"email":"liyibo_lz@163.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-10-15  14:24:18",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"泪眼问情",
		"email":"hhh3luo@126.com",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2013-10-15  19:50:25",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"valiant123",
		"email":"155235489@qq.com",
		"email_2":"",
		"qq":155235489,
		"show_mail_time":"2013-10-15  22:25:43",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"创业不易2012",
		"email":"328046020@qq.com",
		"email_2":"",
		"qq":328046020,
		"show_mail_time":"2013-10-16  10:53:21",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"我的心太鸾",//305
		"email":"466099402@qq.com",
		"email_2":"",
		"qq":466099402,
		"show_mail_time":"2013-10-26  13:56:50",
		"label":[],
		"intro":""
	},
	{
		"uname_in_bbs":"将军草",
		"email":"id_augur@yahoo.com.cn",
		"email_2":"",
		"qq":0,
		"show_mail_time":"2006-01-04  12:30:52",//floor 437
		"label":[],
		"intro":""
	}



];



//1 prepare

//1.1 update parent_id
var parent_timestamp = "2013-07-05  09:30:28";//思维导图
var parent_date = new Date(parent_timestamp);
var parent_id = 296012;//
/*
var par = db.pages.find({"meta.created_at":parent_date});
while (par.hasNext()){
	var temp = par.next();
	parent_id = temp['page_id'];
	//printjson(parent_id);
}
*/

var count = 0;

//2 update email
users_296_308.forEach(function(user){

	//1-load field
	var uname_in_bbs = user['uname_in_bbs'];
	var email = user['email'].toLowerCase();
	var email_2 = user['email_2']? user['email_2'].toLowerCase() : "";
	var qq = user['qq']? user['qq'] : 0;
	var timestamp = user['show_mail_time'];
	var show_mail_time = new Date(user['show_mail_time']);

	var label = user['label'];//["版主","土哥","土师爷"];
	var intro = user['intro']?user['intro']:"";//"风云(中国第一本企业家自传) 作者";

	
	var day = user['born_in_date'];//born info

	//email各种标签["show_mails","索取全文","思维导图","石油篇","383改革方案","中国梦"]
	var tags = user['tags'];



	/*
	var gender = user['gender'];
	var born_in_city = user['born_in_city'];
	*/

	//2-update email

	var u = db.users.find({"uname_in_bbs":uname_in_bbs});
	while (u.hasNext()){
		var temp = u.next();
		var email1 = temp['email'];
		var email2 = temp['email_2'];
		var email3 = temp["email_3"];
		var qq1 = temp['qq'];
		//printjson(parent_id);

		if (email1 != ""){
			email = (email==email1)?email1:email;
			email = (email==email2)?email2:email;
		};

		var email_3 = "";
		if (email2 != ""){
			email_2 = (email_2==email1)?email1:email_2;
			email_2 = (email_2==email2)?email2:email_2;
			email_3 = email_2;
		};


		if (email3 !=null && email3 != ""){
			email_3 = (email_3==email3)?email3:email_3;
		};

		var value1 = {
			"email":email,
			"email_2":email_2,
			"email_3":email_3,
			"qq":qq,
			"label":[],//默认
			"intro":intro
		};
		var value2 = {
			"show_mail_time":show_mail_time
		};	
	
		/*
		//db.users.update({"uname_in_bbs":uname_in_bbs},{"$unset":{"date":1,"day":1}});
		db.users.update({"uname_in_bbs":uname_in_bbs},{"$set":value1,"$addToSet":value2});
		//printjson(value1);
		//printjson(value2);
		//update label
		if (label!=[]){
			label.forEach(function(l){
				var value_label = {
					"label":l
				};
				//printjson(value_label);
				db.users.update({"uname_in_bbs":uname_in_bbs},{"$addToSet":value_label});
			});
		}

		if (day != null && day != ""){
			var date = new Date(day);
		  var value3 = {
		  	"date":date,
		  	"day":day
		  };
		  //printjson(value3);
		  //db.users.update({"uname_in_bbs":uname_in_bbs},{"$addToSet":{"born_in_date2":value3}});
		}
*/
	};
	


	//3-check users results
	
	var u = db.users.find({"uname_in_bbs":uname_in_bbs},{"_id":0,"uname_in_bbs":1,"email":1,"email_2":1});
	while(u.hasNext()){
		count++;
		var temp = u.next();
		printjson(temp);
	};
	
	

 	
 	//4-update pages  info
 	//======================================
 	/*
	//find page_id
	var page_id = 0;
	var p = db.pages.find({"meta.created_at":show_mail_time});
	while (p.hasNext()){
		var temp = p.next();
		page_id = temp['page_id'];
	}
	
	var value = {
		"key":"e",
		"pair":{"timestamp":parent_timestamp,"pair_id":parent_id},
		"parent":{"timestamp":parent_timestamp,"parent_id":parent_id},
		"degree":6.3,
		"info":{
			"uname_in_bbs":uname_in_bbs,
			"email":email,
			"email_2":email_2,
			"show_mail_time":timestamp,
			"qq":qq,
			//"born_in_date":{"date":"ISODate","day":"timestamp"},
			"tags":["show_mails","索取全文"],//default
			"label":label,
			"intro":intro
		}

	};

	//printjson(value);
	db.pages.update({"meta.created_at":show_mail_time},{"$set":value});

	//update tag  ["冰雪整理版",思维导图","石油篇","383改革方案","王功权","中国梦"]
	if (tags!=null&&tags!=[]){
		tags.forEach(function(tag){
			var value2 = {
				"tags":tag
			}
	    db.pages.update({"meta.created_at":show_mail_time},{"$addToSet":value2});			
		});
	};

	//===========================
	*/

	//5-show pages result
	//db.pages.find({"tags":"show_mails"})
	/*
	var pu = db.pages.find({"meta.created_at":show_mail_time});//,{"_id":0,"content":1,"tags"1,"info":1,"degree":1}
	while(pu.hasNext()){
		count++;
		var temp = pu.next();
		db.pages.update({"meta.created_at":show_mail_time},{"$pushAll":{"tags":["show_mails","索取全文"]}})
		printjson(temp);
	};
	*/
	
	///count++;

});

printjson(count);//47




//5 show result

/*

db.users.find({"email":{"$ne":null}}).count()
102
> db.users.find({"email":{"$ne":null}},{"email":1,"_id":0,"uname_in_bbs":1})


{
	"_id" : ObjectId("5426dd60c89b1f5f04e7971b"),
	"follow_ten" : [ ],
	"fl_total" : null,
	"islive" : true,
	"__v" : 0,
	"remember_created_at" : ISODate("2009-03-02T11:04:00Z"),
	"last_sign_in_at" : ISODate("2014-09-06T00:46:33Z"),
	"encrypted_password" : "",
	"sign_in_count" : 99,
	"score_in_bbs" : 267,
	"uid_in_bbs" : "22343832",
	"uname_in_bbs" : "ever73",
	"head_image_url" : "http://tx.tianyaui.com/logo/22343832",
	"bbs_life_year" : 5,
	"email" : "ever73@163.com",
	"email_2" : "",
	"email_3" : "",
	"qq" : 0,
	"label" : [ ],
	"intro" : "",
	"show_mail_time" : [
		ISODate("2013-09-26T04:19:31Z")
	]
}


*/


